
var messageform = $('#myModal-body').html();
var myModalfooter = $('#myModal-footer').html();
var feedbak_form;
var add_info_post; 
var postTags=new Array(); 
var favedTags=new Array();
var icon_ok = '<h4> تم الارسال </h4>';
var progress_bar='<div class="progress progress-striped active"><div class="bar" style="width: 100%;"></div></div>';
var clicked_user;
var search_activated=false;
var go=true;
var last_msg;
var connected=false;
var form_fields="";
var reportedPosts=new Array();
var setTime=5000; 
var setTimeNotif=5000;
function set_clicked_user(id){clicked_user=id; }
$("[rel=tooltip]").tooltip({placement:'left'});
$(".icon-flag").tooltip({placement:'right'});
$("#profilePopover").popover({trigger:'hover'});
var send_messageQueryActive=false;
function send_message(){
login();if(!connected) return;
	var textarea=$("#projet_messagebundle_messagetype_content");
	textarea.val(textarea.val().replace(/\U0020+/g, ' '));	
	if (textarea.val()==' ') return;
        if(textarea.val().length==0) return;
        var fields = $("form").serialize();    
        var str = fields;
        $('#myModal-body').html(progress_bar);
         var myurl=Routing.generate('ProjetMessageBundle_send',{"id":clicked_user,"action":"nothing"});
		 $.ajax({
                    type: "POST",
                    url: myurl ,
                    data: str,
                    beforeSend:function(){
                        if(send_messageQueryActive) return;
                        send_messageQueryActive=true;
                    },
                    success: function(msg){
                        if(msg=="sent")
                        alertify.log("<center><b> تم الإرسال بنجاح    </b></center>");
                        if(msg=="blocking")
                        alertify.log("<center><b> لا يمكن إرسال رسائل إلى عضو محظور   </b></center>");
                        if(msg=="blocked")
                        alertify.log("<center><b>  لا يمكنك إرسال رسائل إلى هذا العضو  </b></center>");
                        if(msg=="faild")
                        alertify.log("<center><b>  لم تتم الاضا?ة بسبب مشكلة ما   </b></center>");
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown){},
                    complete: function(){
                       send_messageQueryActive=false;
                       $('#myModal').delay(1000).modal('hide');
                    }
                 });

}
var myModal2=$('#myModal2-body').html();
var myModal3=$('#myModal3-body').html();
var myModal_unfav=$('#myModal_unfav-body').html();
var unblock_Modal=$('#unblock_Modal-body').html();
$('#myModal').on('show', function () {
    login();if(!connected) return;
	  $('#myModal-body').html(messageform);
 	  $('#myModal-footer').html(myModalfooter);
       });
$('#myModal2').on('show', function () {
    login();if(!connected) return;
	  $('#myModal2-body').html(myModal2);
       });
$('#myModal3').on('show', function () {
    login();if(!connected) return;
	  $('#myModal3-body').html(myModal3);
       });
$('#Modal_unfav').on('show', function () {
	  $('#Modal_unfav-body').html(myModal_unfav);
       });
$('#unblock_Modal').on('show', function () {
	  $('#unblock_Modal-body').html(unblock_Modal);
       });
function add_fav(){
login();if(!connected) return;

         $('#myModal2-body').html(progress_bar);
         var myurl=Routing.generate('ProjetAccountBundle_fav',{id:clicked_user});

   $.ajax({
    type: "POST",
    url: myurl ,
    beforeSend:function(){},
    success: function( msg ) {
            if(msg=="faved")
            alertify.log("<center><b>تم اضا?ة العضو بنجاح </b></center>");
            if(msg=="already")
            alertify.error("<center><b>  قمت باضا?ة هذا العضو من قبل  </b></center>");
            if(msg=="faild")
            alertify.log("<center><b>  لم تتم الاضا?ة بسبب مشكلة ما   </b></center>");
	},
    error: function(XMLHttpRequest, textStatus, errorThrown){},
    complete: function(){$('#myModal2').delay(1000).modal('hide');}
	
  });
}

function blockuser(){
login();if(!connected) return;

    $('#myModal3-body').html(progress_bar);
    var myurl=Routing.generate('ProjetAccountBundle_blockuser',{id:clicked_user});
$.ajax({
    type: "POST",
    url: myurl ,
    beforeSend:function(){},
    success: function( msg ) {
            if(msg=="blocked")
            alertify.log("<center><b> تم الحظر بنجاح </b></center>");
            if(msg=="already")
            alertify.error("<center><b> قمت بحظر هذا العضو من قبل </b></center>");
            if(msg=="faild")
            alertify.log("<center><b> لم يتم الحظر بسبب مشكلة ما  </b></center>");
	},
    error: function(XMLHttpRequest, textStatus, errorThrown){},
    complete: function(){$('#myModal3').delay(1000).modal('hide');}
	
  });

}
function unfav(){

   $('#Modal_unfav-body').html(progress_bar);
   var myurl=Routing.generate('ProjetAccountBundle_unfav',{id:clicked_user});
   $.ajax({
    type: "POST",
    url: myurl ,
    beforeSend:function(){},
    success: function( msg ) {
      $('#Modal_unfav-body').html(msg);
      window.location.reload();	     
	},
    error: function(XMLHttpRequest, textStatus, errorThrown){},
    complete: function(){$('#Modal_unfav').delay(1000).modal('hide');}
	
  });
  
}
function unblock(){
         $('#unblock_Modal-body').html(progress_bar);
         var myurl=Routing.generate('ProjetAccountBundle_unblock',{id:clicked_user});
   $.ajax({
        type: "POST",
        url: myurl ,
        beforeSend:function(){},
        success: function( msg ) {
            $('#unblock_Modal-body').html(msg);
            window.location.reload();    
	},
        error: function(XMLHttpRequest, textStatus, errorThrown){},
        complete: function(){$('#unblock_Modal').delay(1000).modal('hide');}
	
  });
}
$('img.username-popover').hover(function(){ 
    var el=$(this);
    var userid= el.attr("d-popover");
	var selector1='.popover-'+userid+'-content:first';
	var selector2='.popover-'+userid+'-title:first';
    var d=$(selector1).html();
    var t=$(selector2).html();
    el.popover({title: t,content: d,placement:'left'}).popover('show');

},

function(){ 
    var el=$(this);
    var userid= el.attr("d-popover");
	var selector1='.popover-'+userid+'-content:first';
	var selector2='.popover-'+userid+'-title:first';
    var d=$(selector1).html();
    var t=$(selector2).html();
    el.popover({title: t,content: d,placement:'left'}).popover('hide');

}
);

function firePopover(el){

    var el=$(el);
    var userid= el.attr("d-popover");
	var selector1='.popover-'+userid+'-content:first';
	var selector2='.popover-'+userid+'-title:first';
    var d=$(selector1).html();
    var t=$(selector2).html();
    el.popover({title: t,content: d,placement:'left'}).popover('toggle');

}

window.onscroll=function(){
	var members_page=$('#members-container').attr('page');
        var m_data_type=$('#members-container').attr('data_type');
	if(members_page!==undefined)
	if(($(document).height() - $(window).height())-$(window).scrollTop()<100 && go){
		go=false;
        
        switch(m_data_type){
        case "latest_rankings_all":
          var myurl=Routing.generate('ProjetAccountBundle_members',{type:"latest",time:"all","page":members_page});
          break;
        case "best_rankings_all":
          var myurl=Routing.generate('ProjetAccountBundle_members',{time:"all","page":members_page});
          break;
        case "best_rankings_month":
          var myurl=Routing.generate('ProjetAccountBundle_members',{time:"month","page":members_page});
          break;
        case "best_rankings_week":
          var myurl=Routing.generate('ProjetAccountBundle_members',{time:"week","page":members_page});
          break;
        case "best_rankings_day":
          var myurl=Routing.generate('ProjetAccountBundle_members',{time:"day","page":members_page});
          break;
          
          default:;
          
        }
        
        $("#loading").fadeIn();
        $.ajax({
                type: "POST",
                url: myurl ,
                success: function(data) {

                         $("#loading").fadeOut();
                         $('#members-container').append(data);
                         if(data.length>36){
                         $('#members-container').attr('page',(parseInt(members_page))+1);
                         go=true;
                         }
                   },
		complete:function(){ $("#loading").fadeOut();}
        });
              }
	var favs_page=$('#favs-container').attr('page');
	if(favs_page!==undefined)
		if(($(document).height()-$(window).height())-$(window).scrollTop()<100 && go){
		go=false;
	        var myurl=Routing.generate('ProjetAccountBundle_favs',{"page":favs_page});
	        $("#loading").fadeIn();
	        $.ajax({
	        type: "POST",
	        url: myurl,
                beforeSend:function(){},
	        success: function( data ) {
                        $("#loading").fadeOut();
                        $('#favs-container').append(data);
                        if(data.length>28)
                        $('#favs-container').attr('page',(parseInt(favs_page))+1);
                        go=true;
	                  },
                error: function(XMLHttpRequest, textStatus, errorThrown){
                },
		complete:function(){}
                                  
                });
	              }
	var publications_page=$('#publications-container').attr('page');
        var data_type=$('#publications-container').attr('data_type');
        var username=$('#publications-container').attr('username');
        var v_tag=$('#publications-container').attr('v_tag');
	var query=$('#publications-container').attr('query');
		
	if(publications_page!==undefined)
	if(($(document).height() - $(window).height())-$(window).scrollTop()<200 && go){
	go=false;
        switch(data_type)
        {
        case "best_all":
          var myurl=Routing.generate('ProjetPublicationBundle_homepage',{"page":publications_page,"type":"best","time":"all"});
          break;
        case "video":
          var myurl=Routing.generate('ProjetPublicationBundle_homepage',{"page":publications_page,"type":"video","time":"day"});
          break;
        case "photo":
          var myurl=Routing.generate('ProjetPublicationBundle_homepage',{"page":publications_page,"type":"photo","time":"week"});
          break;
        case "best_month":
          var myurl=Routing.generate('ProjetPublicationBundle_homepage',{"page":publications_page,"type":"best","time":"month"});
          break;
        case "latest_all":
          var myurl=Routing.generate('ProjetPublicationBundle_homepage',{"page":publications_page,"type":"latest","time":"all"});
          break;
  
	case "user_best_all":
          var myurl=Routing.generate('ProjetPublicationBundle_user_posts',{"page":publications_page,"username":username,"type":"best","time":"all"});
          break;
        case "user_best_week":
          var myurl=Routing.generate('ProjetPublicationBundle_user_posts',{"page":publications_page,"username":username,"type":"best","time":"week"});
          break;
        case "user_best_month":
          var myurl=Routing.generate('ProjetPublicationBundle_user_posts',{"page":publications_page,"username":username,"type":"best","time":"month"});
          break;
        case "user_latest_all":
          var myurl=Routing.generate('ProjetPublicationBundle_user_posts',{"page":publications_page,"username":username,"type":"latest","time":"all"});
          break;

        case "tag_best":
          var myurl=Routing.generate('ProjetPublicationBundle_tag_posts',{"page":publications_page,"tag":v_tag,"type":"best"});
          break;
          
        case "tag_latest":
          var myurl=Routing.generate('ProjetPublicationBundle_tag_posts',{"page":publications_page,"tag":v_tag,"type":"latest"});
          break;
  
        case "faved_taged":
          var myurl=Routing.generate('ProjetPublicationBundle_taged_posts',{"page":publications_page});
          break;
		  
        case "voted_all":
          var myurl=Routing.generate('ProjetPublicationBundle_user_posts',{"page":publications_page,"username":username,"type":"voted","time":"all"});
          break;
          
        case "spam":
          var myurl=Routing.generate('ProjetPublicationBundle_moderator',{"page":publications_page,"type":"spam"});
          break;
          
        case "feedback":
          var myurl=Routing.generate('ProjetPublicationBundle_moderator',{"page":publications_page,"type":"feedback"});
          break;
		  
        case "search_all":
          var myurl=Routing.generate('ProjetPublicationBundle_search_posts',{"page":publications_page});
		  form_fields=$("#search > form").serialize();
          break;  
          
		  
        default:;
        }
        $("#loading").fadeIn();
        $.ajax({
                type: "POST",
                url: myurl ,
		data: form_fields,
                beforeSend:function(){},
                success:function( data ){
                        $('#publications-container').append(data);
						
                        if(data.length>28){
						 
                            if(data_type=="video" || data_type=="photo" ) Galleria.run('.galleria:gt('+(12*(publications_page-1)-1)+')');
							$('#publications-container').attr('page',(parseInt(publications_page))+1);
							go=true;
		        }
                },
                error: function(XMLHttpRequest, textStatus, errorThrown){
		go=true; 
		},
		complete:function(){$("#loading").fadeOut();}
                                        	  
          });
	}
	
	
};

function load_discussion(){
	   var p=$('#discussion-container').attr('page');
	   var msg=$('.message12').first().attr('idmsg');
	   var id_user=$('#discussion-container').attr('iduser');
	  $('.loading_msg').html(progress_bar);
      var myurl=Routing.generate('ProjetMessageBundle_read',{"page":p,"id":id_user});

      $.ajax({
           type: "POST",
           url: myurl ,
           beforeSend:function(){},
           success: function(msg){
	              $('.loading_msg').html("");
                      $('#dds-container').prepend(msg);
                      set_messages_time();
                      if(msg.length>280)
                      $('#discussion-container').attr('page',(parseInt(p))+1);
					  },
		   error: function(XMLHttpRequest, textStatus, errorThrown){
		   $('.loading_msg').html("");
		   
		   }
});

}

function quik_message(){
login();if(!connected) return;
    
    var textarea=$("#projet_messagebundle_messagetype_content");
    var textarea_val=textarea.val();
            
    if (textarea_val.length==0) return;
    if (textarea_val.replace(/\U0020+/g, ' ')==' ') return;
    if (textarea_val.replace(/\U0032+/g, ' ')==' ' ) return;
        
     var objDiv = document.getElementById("dds-container");
     var fields = $("form").serialize();
     var id_user=$('#discussion-container').attr('iduser');
     $('.loading_bar').fadeIn(0);
     var myurl=Routing.generate('ProjetMessageBundle_send',{"id":id_user,"action":"render"});
	 $.ajax({
          type: "POST",
          url: myurl ,
          data: fields,
          beforeSend:function(){},
          success: function(msg){ 
                        if(msg==='blocked'){
                        alertify.error("<b>  هدا العضو قام بتجاهل رسائلك  </b>");
                        }
                        else if(msg==='blocking'){
                        alertify.error("<b>  لقد قمت بحظر هدا العضو   </b>");
                        }
                        else{
                        $('#insert-msg > textarea').val("");
                        $('#dds-container').append(msg);            
                        }
                        $('.loading_bar').fadeOut(0);
                        objDiv.scrollTop = objDiv.scrollHeight;
          },
          error: function(XMLHttpRequest, textStatus, errorThrown){},
          complete:function(){$('.loading_bar').fadeOut();}
             });
	 
}
function get_response(){
     var objDiv = document.getElementById("dds-container");
     var id_user=$('#discussion-container').attr('iduser');
     var idmsg=$('.message12').last().attr('idmsg');
     var myurl=Routing.generate('ProjetMessageBundle_chat_response',{"from":id_user,"idmsg":idmsg});
     $.ajax({
            type: "POST",
            url: myurl ,
            beforeSend:function(){},
            success: function(data){ 
            	$('#dds-container').append(data);
            	if(data.length>3)
                    objDiv.scrollTop = objDiv.scrollHeight;
            },
            error: function(XMLHttpRequest, textStatus, errorThrown){},
            complete:function(){
                setTimeout('get_response()', setTime); 
            }
            
        });

}

function getNewMsg() {
    var old_data=$("#new_msg_nb").text();
    var id_user=$('#discussion-container').attr('iduser');
	
    if(id_user!==undefined)
    	var myurl=Routing.generate('ProjetMessageBundle_new_messages',{"old_data":old_data,"action":"ignore", "id_sender":id_user });
    else 
    	var myurl=Routing.generate('ProjetMessageBundle_new_messages',{"old_data":old_data});
		
	$.ajax({
	type: "POST",
	url: myurl,
        beforeSend:function(){},
	success:function( data ) {
	if(parseInt(data)>0){
		$('#new_msg_nb').html(data).parent().addClass("badge-warning ");
		$('#layout_messages').html(data).addClass("badge-warning ");
		
		if(parseInt(data)>parseInt(old_data))
		alertify.log( "<center><h4> رسائل جديدة   : "+data+" </h4></center>","custom");
		old_data= parseInt(data);
	}
	
        },
	error: function(XMLHttpRequest, textStatus, errorThrown){},
	complete:function(){
	setTimeout('getNewMsg()', setTimeNotif); 
	}
	});


}

$(".nav-collapse li").mouseenter(function(){
	$(this).addClass("active");
});

$(".nav-collapse li").mouseleave(function(){
	$(this).removeClass("active");
});

function set_messages_time(){
	 moment.lang("ar-ma");
	$(".msg-time").html(function(){
		return moment($(this).attr("time"), "hh:mm:ss DDMMYYYY Z").fromNow();
	});
	setTimeout('set_messages_time()', 1000); 
}

var old_data_notif=0;
function get_notifications(){
    
   var myurl=Routing.generate('ProjetAccountBundle_count_notifications');
    	
	$.ajax({
	type: "POST",
	url: myurl ,
        beforeSend:function(){},
	success:function( data ) {
	   if(parseInt(data)>0){
             $('.notifications-counter').html(data);
             $('.notifications-color').addClass("label-warning");
	 
		if(parseInt(data)>old_data_notif){
		alertify.log("<center><h3> اشعارات جديدة  : "+data+" </h3></center>","custom");
		}
		old_data_notif= parseInt(data);
		}
	},
	error: function(XMLHttpRequest, textStatus, errorThrown){},
	complete: function(){
	setTimeout('get_notifications()', setTimeNotif);
	}
	});
}

var publicationQueryActive=false;
function publication(){
     var ok=true;
    $("#projet_publicationbundle_publicationtype_tags").val(postTags);
	
    var titre=$("#projet_publicationbundle_publicationtype_title");
    var content=$("#projet_publicationbundle_publicationtype_content");
    var source=$("#projet_publicationbundle_publicationtype_source");
	var video=$("#projet_publicationbundle_publicationtype_vidLink");
	var photos=$("#projet_publicationbundle_publicationtype_picLink input");
    var raw_titre=$("#projet_publicationbundle_publicationtype_title").val();
    var raw_content=$("#projet_publicationbundle_publicationtype_content").val();	
	
	photos.each(function(){
	if(!isImage($(this).val())){ ok=false;alertify.error("   رابط الصورة غير صحيح  ");}
	});
	
	if(video.val().length>0 && !isValidVideo(video.val())) { ok=false;alertify.error("  رابط الفيديو  غير صحيح  "); }
     
	titre.val(raw_titre.replace(/\u0020+/gm, ' '));	
	content.val(raw_content.replace(/\u0020+/gm, ' '));
              
			  
	if ($.trim(content.val()).length<30 && photos.length==0 && !isValidVideo(video.val()) ){ok=false;alertify.error("  المعلومة قصيرة جدا أو غير موجودة   ");}
	if ($.trim(titre.val()).length<5){ok=false;alertify.error("  العنوان قصير جداً أو لا يوجد  ");}
	if (raw_titre.length>500){ok=false;alertify.error(" العنوان طويل جداً  ");}
	if (postTags.length==0){ok=false;alertify.error("  لا توجد كلمات دلالية  ");}
	if(photos.length==0 && !isValidVideo(video.val()))
	if($.trim(content.val()).length>30 && !isArabic(raw_content,75)){ok=false;alertify.error("  يجب أن يكون المحتوى العربي أكثر من %75  ");}
    if($.trim(titre.val()).length>5 && !isArabic(raw_titre,100)){ok=false;alertify.error("  حروف العنوان ليست عربية ");}
    if(source.val().length >0 && !isUrl(source.val())){ok=false;alertify.error("   يرجى إعطاء رابط صحيح للمصدر   ");}
	
	if(ok){
            var fields=$("#ma3looma-body > form").serialize();
	    $("#main-ajax-loader").toggle();
            
	       var myurl=Routing.generate('ProjetPublicationBundle_send_post');
		$.ajax({
		type: "POST",
		url: myurl,
	        data: fields,
                beforeSend:function(){
                    if(publicationQueryActive) return;
                    publicationQueryActive=true;
                },
		success:function( data ) {
		           if(data=="ok"){
                      alertify.log("<center><h3> تمت إضافة المعلومة بنجاح </h3></center>","custom");
	                  window.location = Routing.generate('ProjetPublicationBundle_homepage',{"type":"latest","time":"all"});	
			      }else alertify.error("<center><h3>"+data+"</h3></center>");
		},
		error: function(XMLHttpRequest, textStatus, errorThrown){},
                complete:function(){
                  $("#main-ajax-loader").toggle();
                  //publicationQueryActive=false;
                }
		});

    }
	}
	
	

function isMobile(){
        if(
             navigator.userAgent.match(/Android/i)!==null          ||
             navigator.userAgent.match(/BlackBerry/i)!==null       ||
             navigator.userAgent.match(/iPhone|iPad|iPod/i)!==null ||
             navigator.userAgent.match(/Opera Mini/i)!==null       ||
	     navigator.userAgent.match(/Opera Mobi/i)!==null       ||
             navigator.userAgent.match(/webOS/i)!==null            ||
             navigator.userAgent.match(/IEMobile/i)!==null         
		) return true;
		return false;
}

function show_comment(id){
login();if(!connected) return;
    var form=$("#comment-form").html();
	var elem=$("#"+id+"-comment-form");
	elem.html(form);
	$("#"+id+"-comment").toggle();
	var el=elem.find('.flat_textarea2').find(' textarea');
	var old_scrollheight=38;
        el.on('keyup', function (){
           if(this.scrollHeight>old_scrollheight) 
           el.css("height",this.scrollHeight);
           old_scrollheight=this.scrollHeight;
        });
}

var old_scrollheight=0;

$('.flat_textarea > textarea').on('keyup', function (){
   if(this.scrollHeight>old_scrollheight) 
   $(this).css("height",this.scrollHeight);
   old_scrollheight=this.scrollHeight;
});

var send_commentQueryActive=false;
function send_comment(id){     console.log("send_comment id="+id);
    login();if(!connected){return 0;}
    console.log("send_comment 1");
	var textarea=$("#"+id+"-comment-form #projet_publicationbundle_commenttype_content");
	textarea.val(textarea.val().replace(/\U0020+/g, ' '));			console.log("textarea.val()="+textarea.val());
	if(textarea.val()==' '){return 0;  }
	if(textarea.val().length==0){return 0;}
	if(textarea.val().length>1000){ alertify.error("  لا يمكن للتعليق أن تجاوز 1000 حر?  ");return 0;  }
	console.log("send_comment 2");
	var fields = $("#"+id+"-comment-form > form").serialize();	
	$("#"+id+"-ajax-loader").show();
        var myurl=Routing.generate('ProjetPublicationBundle_comment',{"id":id});
	$.ajax({
	type: "POST",
	url: myurl ,
        data: fields,
        beforeSend:function(){
            if(send_commentQueryActive) return;
            send_commentQueryActive=true;
        },
	success:function( data ) {
        $('#'+id+'-comments-container').append(data);
        $("#"+id+"-comment-form textarea").val("");
	var n=parseInt($("#nb-comments-"+id).html());
	$("#nb-comments-"+id).html(n+1);
	$('.flat_textarea2 textarea').height(30);
	},
	
	error: function(XMLHttpRequest, textStatus, errorThrown){},
	
	complete:function(){
            send_commentQueryActive=false;
	    $("#"+id+"-ajax-loader").toggle();
	}
	});
}

function get_comments(id){
	$("#"+id+"-ajax-loader").fadeIn(0);
	if($("#"+id+"-comments-container").attr("comments-loaded")=="false"){
	var myurl=Routing.generate('ProjetPublicationBundle_get_comments',{"id":id});
	    $.ajax({
		type: "POST",
		url: myurl ,
                beforeSend:function(){},
		success:function( data ){
                    $("#"+id+"-comments-container").html(data);
                    $("#"+id+"-comments-container").attr("comments-loaded","true");
			},
		error: function(XMLHttpRequest, textStatus, errorThrown){},
                complete:function(){
                    $("#"+id+"-ajax-loader").fadeOut(0);
                }  
	});
      }else{
    	  $("#"+id+"-comments-container").toggle();
    	  $("#"+id+"-ajax-loader").toggle();
      }

}

var like_publicationQueryActive=false;
function like_publication(id){
login();if(!connected) return;
	
$("#"+id+"-ajax-loader").show();
    var myurl=Routing.generate('ProjetPublicationBundle_like_post',{"id":id});
        $.ajax({
            type: "POST",
            url: myurl ,
            beforeSend:function(){
                if(like_publicationQueryActive) return;
                like_publicationQueryActive=true;
            },
            success:function( data ) {
                if(data!=="0")
                    $("#votesbar-"+id).html(data);
                else 
                    alertify.error("<center> لا يمكنك التصويت على معلوماتك  </center>");
            },
            error: function(XMLHttpRequest, textStatus, errorThrown){},
            complete:function(){
              like_publicationQueryActive=false;
              $("#"+id+"-ajax-loader").hide();
            }
            });
}

var dislike_publicationQueryActive=false;
function dislike_publication(id){
login();if(!connected) return;
	
    $("#"+id+"-ajax-loader").show();
        var myurl=Routing.generate('ProjetPublicationBundle_dislike_post',{"id":id});
            $.ajax({
                type: "POST",
                url: myurl ,
                beforeSend:function(){
                    if(dislike_publicationQueryActive) return;
                    dislike_publicationQueryActive=true;
                },
                success:function( data ) {
                   if(data!=="0")
                       $("#votesbar-"+id).html(data);
                   else 
                       alertify.error("<center> لا يمكنك التصويت على معلوماتك  </center>");
                },
                error: function(XMLHttpRequest, textStatus, errorThrown){},
                complete:function(){
                    dislike_publicationQueryActive=false;
                    $("#"+id+"-ajax-loader").hide();
                }
                });
}

var delete_publicationQueryActive=false;
function delete_publication(id){
	$("#"+id+"-ajax-loader").show();
    var myurl=Routing.generate('ProjetPublicationBundle_delete_post',{"id":id});
	$.ajax({
            type: "POST",
            url: myurl ,
            beforeSend:function(){
                if(delete_publicationQueryActive) return;
                delete_publicationQueryActive=true;
            },
            success:function( data ) {
                    if(data=="protected")
                    alertify.log("<center><b> لا يمكن ازالة هاته المعلومة <br> لان لديها اكثر من 10 اصوات ايجابية </b></center>");

                    if(data=="deleted"){
                    $("#publication-"+id).slideUp(700); 
                    alertify.log("  تم ازالة المعلومة  ");
                    }
            },
            error: function(XMLHttpRequest, textStatus, errorThrown){},
            complete: function(){
                delete_publicationQueryActive=false;
                $("#"+id+"-ajax-loader").toggle();
            }
            });
}

var delete_commentQueryActive=false;
function delete_comment(id,post_id){
	
	$("#comment-ajax-loader-"+id).show();
        var myurl=Routing.generate('ProjetPublicationBundle_delete_comment',{"id":id});
	$.ajax({
            type: "POST",
            url: myurl ,
            beforeSend:function(){
                if(delete_commentQueryActive) return;
                delete_commentQueryActive=true;
            },
            success:function( data ) {
                if(data=="ok"){
                   $("#comment-"+id).slideUp(700);
                   var n=parseInt($("#nb-comments-"+post_id).html());
                   $("#nb-comments-"+post_id).html(n-1);
                    }
            },
            error: function(XMLHttpRequest, textStatus, errorThrown){},
            complete: function(){
                delete_commentQueryActive=false;
                $("#comment-ajax-loader-"+id).toggle();
            }
            });
}

var unlike_publicationQueryActive=false;
function unlike_publication(id){

	$("#"+id+"-ajax-loader").show();
	    var myurl=Routing.generate('ProjetPublicationBundle_unlike_post',{"id":id});
		$.ajax({
                    type: "POST",
                    url: myurl ,
                    beforeSend:function(){
                        if(unlike_publicationQueryActive) return;
                        unlike_publicationQueryActive=true;
                    },
                    success:function( data ) {
                      $("#votesbar-"+id).html(data);
                                      
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown){},
                    complete: function(){
                        unlike_publicationQueryActive=false;
                        $("#"+id+"-ajax-loader").hide(); 
                    }        
                    });

}

var undislike_publicationQueryActive=false;
function undislike_publication(id){
	$("#"+id+"-ajax-loader").show();
	    var myurl=Routing.generate('ProjetPublicationBundle_undislike_post',{"id":id});
		$.ajax({
                    type: "POST",
                    url: myurl ,
                    beforeSend:function(){
                        if(undislike_publicationQueryActive) return;
                        undislike_publicationQueryActive=true;
                    },
                    success:function( data ) {
                      $("#votesbar-"+id).html(data);
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown){},
                    complete: function(){
                        undislike_publicationQueryActive=false;
                        $("#"+id+"-ajax-loader").hide(); 
                    }  
                    });
}

function delete_notification(id){
	   var myurl=Routing.generate('ProjetAccountBundle_delete_notification',{"id":id});

            $.ajax({
                type: "POST",
                url: myurl
                });
}

function isConnected(){
        var myurl=Routing.generate('ProjetAdministrationBundle_check_identification');
		$.ajax({
		type: "POST",
		url: myurl ,
                beforeSend:function(){},
		success:function( data ) {
                    if(data=="connected") 
                        connected=true;
		    else 
                        connected=false;
					
                },
		error: function(XMLHttpRequest, textStatus, errorThrown){
			 setTimeout('isConnected()', 5000); 
		}
		}); 
}

function login(){
if(!connected)
$("#modalConnect").modal('show');
}


function isArabic(content,percent) {
var arabic=new Array();
var nonarabic=new Array();

    for(var i=0;i<content.length;i++){
    var code = content.charCodeAt(i);        
        if((64336<=code && code<=65276) || (1536<=code && code<=1791) || code==32 || code==8206 || code==10)
    arabic.push(code);
        else{
    nonarabic.push(code);
        }
}
var purcent=((arabic.length/content.length)*100)+"";
var t=purcent.substr(0,3);
if(parseInt(t,10)>=percent) return true;
return false;

}

function addFavedPost(id){
login();if(!connected) return;
	$("#"+id+"-ajax-loader").show();
        var myurl=Routing.generate('ProjetAccountBundle_add_faved_post',{"id_post":id});
		$.ajax({
		type: "POST",
		url: myurl ,
	        timeout:60000,
                beforeSend:function(){},
		success:function( data ) {
                    $("#fav_action-"+id).html(data);
					
                },
		error: function(XMLHttpRequest, textStatus, errorThrown){},
                complete:function(){ $("#"+id+"-ajax-loader").hide(); }
		}); 

}

function removeFavedPost(id){
login();if(!connected) return;
       $("#"+id+"-ajax-loader").show();
        var myurl=Routing.generate('ProjetAccountBundle_remove_faved_post',{"id_post":id});
		$.ajax({
		type: "POST",
		url: myurl ,
	        timeout:60000,
                beforeSend:function(){},
		success:function( data ) {
                    $("#fav_action-"+id).html(data);
					
                },
		error: function(XMLHttpRequest, textStatus, errorThrown){},
                complete:function(){ $("#"+id+"-ajax-loader").hide(); }
		}); 

}


$("#projet_publicationbundle_searchtype_query").keyup(function(e){ 
    var code = e.which; // recommended to use e.which, it's normalized across browsers
    if(code===13 ){
        e.preventDefault();
        search_posts();
    }
});


function search_posts(){

        var myurl=Routing.generate('ProjetPublicationBundle_search_posts');
	var query=$("#projet_publicationbundle_searchtype_query").val();
        var fields = $("#search_form input").serialize();
	if(query.length>0){

            $("#search_loader").fadeIn();
            $.ajax({
            type: "POST",
            url: myurl ,
            data: fields,
            timeout:60000,
            beforeSend:function(){},
            success:function( data ) {
                    $("#search_results").html(data);

            },
            error: function(XMLHttpRequest, textStatus, errorThrown){
            },
            complete:function(){
            $("#search_loader").fadeOut();
            }
            }); 
}
}

function get_best_tags(){
    
        var myurl=Routing.generate('ProjetPublicationBundle_best_tags');

             $.ajax({
             type: "POST",
             url: myurl ,
             timeout:60000,
             beforeSend:function(){},
             success:function( data ) {
                     $("#bestTags").html(data);
             },
             error: function(XMLHttpRequest, textStatus, errorThrown){
                     get_best_tags(); 

             }
             });
}           


$(".publication").hover(function(){
    
     $(this).find(".icon-flag").fadeIn(0);
},
function(){
    
     $(this).find(".icon-flag").fadeOut(0);
}
);

var SignalPostQueryActive=false;
function SignalPost(id){
    login();if(!connected) return 0;
        
        if(reportedPosts.indexOf(id)>=0){
            alertify.alert("<center><b>   لقد قمت بالإبلاغ عن هده المعلومة من قبل   </b></center>",
                    { labels: {
                ok     : "OK",
                cancel : "Deny"
                    } });
            return 0;
        }
      	
        var myurl=Routing.generate('ProjetPublicationBundle_signal_post',{"id":id});
        $.ajax({
		type: "POST",
		url: myurl ,
                beforeSend:function(){
                if(SignalPostQueryActive) return;
                SignalPostQueryActive=true;
                },
		success:function( data ){
		if(data=="x"){
                    alertify.alert("<center><b>  لقد قمت بالإبلاغ عن هده المعلومة من قبل   </b></center>");
                    reportedPosts.push(id);
                }
		if(data=="ok"){
		   alertify.log("<center><b> شكرا على جعل الموقع مكان نظي?ا <br>  لقد تم اخبار المشر?ين  </b></center>");
                   reportedPosts.push(id);
                }
                },
		error: function(XMLHttpRequest, textStatus, errorThrown){
		},
                complete:function(){SignalPostQueryActive=false;}
		}); 

}


$('#PostTagsModal').on('show', function () {
$("#PostTagsModalList").html("");
var length = availableTags.length,
    element = null;
        
for (var i = 0; i < length; i++) {
  element = availableTags[i];

    if(postTags.indexOf(element)>=0)
        $("#PostTagsModalList").append('<span class="label label-success hover" onclick="addTagToPost(\''+element+'\',this)" style="padding:3px;margin:4px" ><i class="icon-remove" ></i>'+element+'</label>');
    else
        $("#PostTagsModalList").append('<span class="label hover" onclick="addTagToPost(\''+element+'\',this)" style="padding:3px;margin:4px" ><i class="icon-plus-sign" ></i>'+element+'</label>');
    }
});


  function addTagToPost(MyTag,el){
      var tag_id=MyTag.replace(" ","_");
        
    if(availableTags.indexOf(MyTag)<0) {alertify.error("  هده الكلمة الدلالية غير موجودة  ");$("#_tags").val("");return 0;}
    if(postTags.indexOf(MyTag)>=0) {
    
      selectionRemoved(MyTag,$('#'+tag_id));
      $(el).removeClass("label-success").html('<i class="icon-plus-sign" ></i>'+MyTag);	 
      return;
      }
      if(postTags.length>=3){alertify.error("   ثلاث كلمات هو العدد الأقصى  ");$("#_tags").val("");return 0;}
		  
    postTags.push(MyTag);
    $("#post_tags").append('<span style="margin:3px" class="label"><i class="icon-remove hover"  id="'+tag_id+'" onclick=\'selectionRemoved("'+MyTag+'",this)\' ></i>'+MyTag+'</span>');	  
    $(el).addClass("label-success").html('<i class="icon-remove" ></i>'+MyTag);	  
  }

 function selectionRemoved(tag,elem){
		  var i=postTags.indexOf(tag);
		  postTags.splice(i,1);
		  $(elem).parent().remove();
		}  


$('#FavedTagsModal').on('show', function () {

$(".favedTag").each(function(){
    favedTags.push($(this).text());
    
});
    
$("#FavedTagsModalList").html("");
var length = availableTags.length,
    element = null;
        
for (var i = 0; i < length; i++) {
  element = availableTags[i];

    if(favedTags.indexOf(element)>=0)
        $("#FavedTagsModalList").append('<span class="label label-success hover " onclick="addFavedTag(\''+element+'\',this)" style="padding:3px;margin:4px" ><i class="icon-remove" ></i>'+element+'</label>');
    else
        $("#FavedTagsModalList").append('<span class="label hover " onclick="addFavedTag(\''+element+'\',this)" style="padding:3px;margin:4px" ><i class="icon-plus-sign" ></i>'+element+'</label>');
    }
});


function addFavedTag(tag,el){
    if(favedTags.indexOf(tag)>=0){
        removeFavedTag(tag,el);
        return;
    } 
    var myurl=Routing.generate('ProjetAccountBundle_add_faved_tag',{"tag":tag});

            $.ajax({
            type: "POST",
            url: myurl ,
            timeout:60000,
            beforeSend:function(){},
            success:function( data ) {
                    if(data!=="0"){
                    $("#faved_tags_container").append(data);
                    favedTags.push(tag);
                    $(el).addClass("label-success").html('<i class="icon-remove" ></i>'+tag);	  
                    }

            },
            error: function(XMLHttpRequest, textStatus, errorThrown){
             addFavedTag(tag);
            },
            complete:function(){ }
            }); 

}

function removeFavedTag(tag,el){
    var tag_id=tag.replace(" ","_");
    var myurl=Routing.generate('ProjetAccountBundle_remove_faved_tag',{"tag":tag});
            $.ajax({
            type: "POST",
            url: myurl ,
            timeout:60000,
            beforeSend:function(){},
            success:function( data ){
                 $("#"+tag_id).parent().remove();
                 if(el!==undefined && el!==null )
                     $(el).removeClass("label-success").html('<i class="icon-plus-sign" ></i>'+tag);	
                 favedTags.pop(tag);
            },
            error: function(XMLHttpRequest, textStatus, errorThrown){
            }
            }); 

}


function send_feedback(){
    
	 var textarea=$("#projet_administrationbundle_feedbacktype_content");
	 textarea.val(textarea.val().replace(/\U0020+/g, ' '));	
	 if (textarea.val()!=' '){
	 if(textarea.val().length>0){
	 $("#feedbackprogress").fadeIn();
         var fields = $("#feedbackModal-body > form").serialize();
         var myurl=Routing.generate('ProjetAdministrationBundle_send_feedback');
	 $.ajax({
          type: "POST",
          url: myurl ,
          data: fields,
          success: function(msg){
                  $("#feedbackprogress").fadeOut();
        	  $('#feedbackModal').modal('hide');
        	  textarea.val("");
        	  alertify.log("<h3>  شكراً لك على أرائك و ملاحظاتك   </h3>");
        	  
          },
          error: function(XMLHttpRequest, textStatus, errorThrown){
		 // alertify.error(" ");
          }
             });
	 }
}
}

function isUrl(str){
patt=/(http:\/\/)?(www.)?.*\.\w{2,3}.*/g;
 return patt.test(str);

}

function isImage(url){

return (((url.match(/^(http|https):\/\//)!=null)));
}

function isValidVideo(url){

return (((url.match(/^(http:\/\/youtube.com\/watch\?v=.{11}|http:\/\/vimeo.com\/\d{8}|http:\/\/dailymotion.com\/video\/.{6,7}|http:\/\/www.youtube.com\/watch\?v=.{11}|https:\/\/vimeo.com\/\d{8}|http:\/\/www.dailymotion.com\/video\/.{6,7})/)!=null))); 
}




